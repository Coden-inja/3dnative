<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>360 Player</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    
    <style>
      /* --- UI STYLES --- */
      body { margin: 0; overflow: hidden; font-family: sans-serif; }

      /* UI LAYER (Holds everything on top of video) */
      #ui-layer {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        pointer-events: none; /* Default: Let clicks pass through to drag video */
        z-index: 100;
      }

      /* START SCREEN (Black overlay) */
      #start-screen {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.9); z-index: 200;
        display: flex; justify-content: center; align-items: center;
        pointer-events: auto;
      }
      #start-btn {
        padding: 15px 40px; font-size: 18px; background: white;
        border: none; border-radius: 4px; font-weight: bold; cursor: pointer;
      }
      #start-btn:disabled { opacity: 0.5; cursor: wait; }

      /* CENTER PLAY/PAUSE BUTTON */
      #center-controls {
        position: absolute; top: 50%; left: 50%; 
        transform: translate(-50%, -50%);
        width: 80px; height: 80px;
        pointer-events: auto; /* Clickable */
        cursor: pointer;
        opacity: 1; /* Visible by default */
        transition: opacity 0.3s;
        display: flex; justify-content: center; align-items: center;
        background: rgba(0, 0, 0, 0.6);
        border: 3px solid white; border-radius: 50%;
      }

      /* ICONS */
      .icon-play {
        width: 0; height: 0;
        border-top: 15px solid transparent;
        border-bottom: 15px solid transparent;
        border-left: 25px solid white;
        margin-left: 5px;
      }
      .icon-pause {
        width: 25px; height: 30px;
        border-left: 8px solid white;
        border-right: 8px solid white;
        display: none;
      }

      /* HEADER & FULLSCREEN */
      #ui-header {
        position: absolute; top: 20px; left: 20px; color: white;
        text-shadow: 1px 1px 4px black;
      }
      #fullscreen-btn {
        position: absolute; bottom: 20px; right: 20px;
        pointer-events: auto; cursor: pointer;
        background: rgba(0,0,0,0.5); padding: 10px; border-radius: 5px;
      }
      #fullscreen-btn svg { width: 24px; height: 24px; fill: white; display: block; }

    </style>
  </head>
  <body>

    <div id="start-screen">
      <button id="start-btn" disabled>LOADING...</button>
    </div>

    <div id="ui-layer">
      <div id="ui-header">
        <h1 style="margin:0; font-size:1.2rem;">REAL ESTATE</h1>
        <p style="margin:5px 0 0; font-size:0.8rem; opacity:0.8;">Luxury Apartment â€¢ 4K</p>
      </div>

      <div id="center-controls">
        <div class="icon-play"></div>
        <div class="icon-pause"></div>
      </div>

      <div id="fullscreen-btn">
        <svg viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg>
      </div>
    </div>

    <a-scene loading-screen="dotsColor: white; backgroundColor: black" vr-mode-ui="enabled: false">
      <a-assets>
        <video id="video360" src="video.mp4" loop crossorigin="anonymous" playsinline webkit-playsinline></video>
      </a-assets>
      <a-videosphere src="#video360" rotation="0 -90 0"></a-videosphere>
      <a-entity camera look-controls="reverseMouseDrag: true"></a-entity>
    </a-scene>

    <script>
      const startScreen = document.getElementById('start-screen');
      const startBtn = document.getElementById('start-btn');
      const centerBtn = document.getElementById('center-controls');
      const iconPlay = document.querySelector('.icon-play');
      const iconPause = document.querySelector('.icon-pause');
      const video = document.getElementById('video360');
      const fsBtn = document.getElementById('fullscreen-btn');
      const scene = document.querySelector('a-scene');

      let isControlsVisible = true;

      // 1. ENABLE START BUTTON
      video.addEventListener('canplay', () => {
        startBtn.textContent = "START TOUR";
        startBtn.disabled = false;
      });

      // 2. START EXPERIENCE
      startBtn.addEventListener('click', () => {
        startScreen.style.display = 'none';
        video.play();
        updatePlayState(true);
        requestMotionPermission();
        
        // Hide controls after 2 seconds automatically for immersion
        setTimeout(() => { toggleControls(false); }, 2000);
      });

      // 3. CENTER BUTTON CLICK (Play/Pause)
      centerBtn.addEventListener('click', (e) => {
        e.stopPropagation(); // Prevent drag interference
        if (video.paused) {
          video.play();
          updatePlayState(true);
          toggleControls(false); // Hide button when playing starts
        } else {
          video.pause();
          updatePlayState(false);
          // Keep button visible when paused
        }
      });

      // 4. TAP ANYWHERE TO SHOW/HIDE CONTROLS
      // We distinguish "Tap" vs "Drag"
      let startX = 0, startY = 0;

      scene.addEventListener('mousedown', (e) => { startX = e.screenX; startY = e.screenY; });
      scene.addEventListener('touchstart', (e) => { startX = e.touches[0].screenX; startY = e.touches[0].screenY; });

      const handleTap = (endX, endY) => {
        const diffX = Math.abs(endX - startX);
        const diffY = Math.abs(endY - startY);

        // If moved less than 10px, it's a TAP.
        if (diffX < 10 && diffY < 10) {
          // If video is playing, toggle controls
          if (!video.paused) {
            toggleControls(!isControlsVisible);
          }
        }
      };

      scene.addEventListener('mouseup', (e) => handleTap(e.screenX, e.screenY));
      scene.addEventListener('touchend', (e) => handleTap(e.changedTouches[0].screenX, e.changedTouches[0].screenY));


      // --- HELPER FUNCTIONS ---

      function updatePlayState(isPlaying) {
        if (isPlaying) {
          iconPlay.style.display = 'none';
          iconPause.style.display = 'block';
        } else {
          iconPlay.style.display = 'block';
          iconPause.style.display = 'none';
        }
      }

      function toggleControls(show) {
        isControlsVisible = show;
        if (show) {
          centerBtn.style.opacity = '1';
          centerBtn.style.pointerEvents = 'auto';
        } else {
          centerBtn.style.opacity = '0';
          centerBtn.style.pointerEvents = 'none'; // Unclickable when hidden
        }
      }

      function requestMotionPermission() {
        if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
          DeviceMotionEvent.requestPermission().catch(console.error);
        }
      }

      fsBtn.addEventListener('click', () => {
        if (!document.fullscreenElement) {
          if (document.documentElement.requestFullscreen) document.documentElement.requestFullscreen();
          else if (document.documentElement.webkitRequestFullscreen) document.documentElement.webkitRequestFullscreen();
        } else {
          if (document.exitFullscreen) document.exitFullscreen();
          else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
        }
      });
    </script>
  </body>
</html>