<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>360 Player</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    
    <style>
      /* --- GLOBAL RESET --- */
      html, body {
        width: 100%; height: 100%; margin: 0; padding: 0;
        overflow: hidden; font-family: sans-serif; background-color: black;
      }
      * {
        -webkit-tap-highlight-color: transparent;
        user-select: none; -webkit-user-select: none;
      }

      /* --- UI LAYER --- */
      #ui-layer {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        pointer-events: none; z-index: 100;
      }

      /* --- START SCREEN --- */
      #start-screen {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.9); z-index: 200;
        display: flex; justify-content: center; align-items: center;
        pointer-events: auto;
      }
      #start-btn {
        padding: 15px 40px; font-size: 18px; background: white;
        border: none; border-radius: 4px; font-weight: bold; cursor: pointer;
        outline: none; transition: background 0.3s;
      }
      #start-btn:disabled { opacity: 0.5; cursor: wait; background: #999; }

      /* --- CENTER BUTTON --- */
      #center-controls {
        position: absolute; top: 50%; left: 50%; 
        transform: translate(-50%, -50%);
        width: 80px; height: 80px;
        pointer-events: auto; cursor: pointer;
        display: flex; justify-content: center; align-items: center;
        background: rgba(0, 0, 0, 0.6);
        border: 3px solid white; border-radius: 50%;
        transition: opacity 0.3s;
      }

      .icon-play {
        width: 0; height: 0;
        border-top: 15px solid transparent;
        border-bottom: 15px solid transparent;
        border-left: 25px solid white; margin-left: 5px;
      }
      .icon-pause {
        width: 25px; height: 30px;
        border-left: 8px solid white; border-right: 8px solid white;
        display: none;
      }

      /* --- HEADER & FULLSCREEN --- */
      #ui-header {
        position: absolute; top: 20px; left: 20px; color: white;
        text-shadow: 1px 1px 4px black;
      }
      #fullscreen-btn {
        position: absolute; bottom: 20px; right: 20px;
        pointer-events: auto; cursor: pointer;
        background: rgba(0,0,0,0.5); padding: 10px; border-radius: 5px;
      }
      #fullscreen-btn svg { width: 24px; height: 24px; fill: white; display: block; }
    </style>
  </head>
  <body>

    <div id="start-screen">
      <button id="start-btn" disabled>LOADING...</button>
    </div>

    <div id="ui-layer">
      <div id="ui-header">
        <h1 style="margin:0; font-size:1.2rem;">REAL ESTATE</h1>
        <p style="margin:5px 0 0; font-size:0.8rem; opacity:0.8;">Luxury Apartment â€¢ 4K</p>
      </div>

      <div id="center-controls">
        <div class="icon-play"></div>
        <div class="icon-pause"></div>
      </div>

      <div id="fullscreen-btn">
        <svg viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg>
      </div>
    </div>

    <a-scene loading-screen="dotsColor: white; backgroundColor: black" vr-mode-ui="enabled: false">
      <a-assets>
        <video id="video360" src="video.mp4" loop crossorigin="anonymous" playsinline webkit-playsinline preload="auto"></video>
      </a-assets>
      <a-videosphere src="#video360" rotation="0 -90 0"></a-videosphere>
      <a-entity camera look-controls="reverseMouseDrag: true"></a-entity>
    </a-scene>

    <script>
      const startScreen = document.getElementById('start-screen');
      const startBtn = document.getElementById('start-btn');
      const centerBtn = document.getElementById('center-controls');
      const iconPlay = document.querySelector('.icon-play');
      const iconPause = document.querySelector('.icon-pause');
      const video = document.getElementById('video360');
      const fsBtn = document.getElementById('fullscreen-btn');
      const scene = document.querySelector('a-scene');

      let isControlsVisible = true;

      // --- THE IOS FIX: Force the button to enable ---
      
      // 1. Try to load normally
      video.load();

      // 2. Define the enable function
      function enableButton() {
        if (!startBtn.disabled) return;
        startBtn.textContent = "START TOUR";
        startBtn.disabled = false;
        startBtn.style.cursor = "pointer";
      }

      // 3. Listen for standard events
      video.addEventListener('canplay', enableButton);
      video.addEventListener('loadedmetadata', enableButton);

      // 4. FALLBACK TIMER (The "Safety Net")
      // If iOS blocks the load, this forces the button to appear after 3 seconds anyway.
      setTimeout(() => {
        if (startBtn.disabled) {
          console.log("iOS Fallback Triggered");
          enableButton();
        }
      }, 3000);


      // --- EVENT LISTENERS ---

      startBtn.addEventListener('click', () => {
        startScreen.style.display = 'none';
        
        // This .play() inside a click event unlocks the video on iOS
        video.play().then(() => {
          updatePlayState(true);
        }).catch(err => {
          console.error("Play failed:", err);
          updatePlayState(false);
        });

        requestMotionPermission();
        setTimeout(() => { toggleControls(false); }, 2000);
      });

      centerBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        if (video.paused) {
          video.play();
          updatePlayState(true);
          toggleControls(false);
        } else {
          video.pause();
          updatePlayState(false);
        }
      });

      // --- TAP DETECTION (For showing controls) ---
      let startX = 0, startY = 0;
      scene.addEventListener('mousedown', (e) => { startX = e.screenX; startY = e.screenY; });
      scene.addEventListener('touchstart', (e) => { startX = e.touches[0].screenX; startY = e.touches[0].screenY; });

      const handleTap = (endX, endY) => {
        const diffX = Math.abs(endX - startX);
        const diffY = Math.abs(endY - startY);
        if (diffX < 10 && diffY < 10) {
          if (!video.paused) toggleControls(!isControlsVisible);
        }
      };

      scene.addEventListener('mouseup', (e) => handleTap(e.screenX, e.screenY));
      scene.addEventListener('touchend', (e) => handleTap(e.changedTouches[0].screenX, e.changedTouches[0].screenY));

      // --- HELPERS ---
      function updatePlayState(isPlaying) {
        if (isPlaying) {
          iconPlay.style.display = 'none';
          iconPause.style.display = 'block';
        } else {
          iconPlay.style.display = 'block';
          iconPause.style.display = 'none';
        }
      }

      function toggleControls(show) {
        isControlsVisible = show;
        if (show) {
          centerBtn.style.opacity = '1';
          centerBtn.style.pointerEvents = 'auto';
        } else {
          centerBtn.style.opacity = '0';
          centerBtn.style.pointerEvents = 'none';
        }
      }

      function requestMotionPermission() {
        if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
          DeviceMotionEvent.requestPermission().catch(console.error);
        }
      }

      fsBtn.addEventListener('click', () => {
        if (!document.fullscreenElement) {
          if (document.documentElement.requestFullscreen) document.documentElement.requestFullscreen();
          else if (document.documentElement.webkitRequestFullscreen) document.documentElement.webkitRequestFullscreen();
        } else {
          if (document.exitFullscreen) document.exitFullscreen();
          else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
        }
      });
    </script>
  </body>
</html>